<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>利用链表实现贪食蛇</title>
    <style>
        #game{
            margin-top:5%;
            margin-left: 30%;
        }
        #control{
            width: 400px;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="game">
    <p>游戏规则：吃到食物(红色)分数增加，如果食物长时间不吃，就变成毒药，吃到毒药(绿色)，游戏结束</p>
    <canvas id="snake" width="400" height="400" style="border: 1px solid black"></canvas>
    <div id="control">
        <button id="toggle">开始游戏</button>
        <button id="restart">新游戏</button>
        <span id="score">分数：0</span>
        <span id="level">级别：0</span>
    </div>
</div>
</body>
<script>
    var oSnake=document.getElementById('snake');
    var nodeWidth=10;//每个节点的宽度
    var width=oSnake.offsetWidth/nodeWidth;//水平方向最大步数
    var height=oSnake.offsetHeight/nodeWidth;//竖直方向最大步数
    var flag=true;//开始和暂停的标志位
//单个蛇的节点
    var snakeNode= function (point,curDirection) {
        var curDirection=curDirection,//节点当前方向
                next,//下一个节点
                pos=point; //当前节点的位置(用于设置头结点的位置)
        //获得下一个节点（增加新的节点使用）
        this.getNext= function () {
            return next;
        };
        //设置下一个节点（增加新的节点使用）
        this.setNext= function (element) {
            next=element;
        };
        //设置当前移动方向
        this.setDirection= function (direction) {
            curDirection=direction;
        };
        //获得当前移动方向
        this.getDirection= function () {
            return curDirection;
        };
        //获取当前的位置
        this.getPosition= function () {
            return pos;
        };
        //计算节点的下一个位置
        //注意:整天蛇的联动性，在这里体现。把所有节点的下一个位置计算出来
        //用在头结点，通过头结点查找接下来的每一个节点
        this.computedNextPos= function () {
            pos=this.getNextPoint(pos,curDirection);
            if(this.getNext()){
                this.getNext().computedNextPos();//利用递归的思想，每次都计算下一个节点的位置
                this.getNext().setDirection(curDirection);//设置每个节点的方向
            }
        };
        this.getNextPoint= function (point,direction) {
            var newPoint={};
            switch(direction){
                case 'LEFT':
                    newPoint.x=point.x-1;
                    newPoint.y=point.y;
                    break;
                case 'RIGHT':
                    newPoint.x=point.x+1;
                    newPoint.y=point.y;
                    break;
                case 'TOP':
                    newPoint.x=point.x;
                    newPoint.y=point.y-1;
                    break;
                case 'BOTTOM':
                    newPoint.x=point.x;
                    newPoint.y=point.y+1;
                    break;
            }
            return newPoint;
        }
    };
//贪吃蛇类
    var Snake= function (head) {
        var headNode=head;//定义一个头结点


        //增加一个节点
        //根据头结点找到最后一个节点(增加节点的时候使用)
        this.getLastNode= function () {
            var nextNode=headNode.getNext();
            while(nextNode){
                var lastNode=nextNode.getNext();
                if(!lastNode) return nextNode;
                nextNode=lastNode;
            }
            return headNode;
        };
        this.addNode= function () {
            var lastNode=this.getLastNode();//找到最后一个节点
            //初始化增加的节点（prevDirection,curDirection,next,pos）
            var direction;
            switch(lastNode.getDirection()){
                case 'LEFT':
                    direction='RIGHT';
                    break;
                case 'RIGHT':
                    direction='LEFT';
                    break;
                case 'TOP':
                    direction='BOTTOM';
                    break;
                case 'BOTTOM':
                    direction='TOP';
                    break;
            }
            //通过最后一个节点的位置，确定新增加节点的位置（pos）
            var pos=lastNode.getNextPoint(lastNode.getPosition(),direction);
            var newNode=new snakeNode(pos,lastNode.getDirection());
            //console.log(pos);
            newNode.setDirection(lastNode.getDirection());//设置新增加节点的初始的移动方向
            lastNode.setNext(newNode);//将新增加的节点连接在最后一个节点的后面
        };


        //获得蛇头的位置
        this.getHeadPos= function () {
            return headNode.getPosition();
        };
        //获得蛇头节点方向
        this.getHeadDirection= function () {
            return headNode.getDirection();
        };
        this.setDirection= function (direction) {
            headNode.setDirection(direction);
        };
        //获得蛇所有节点的位置
        this.getAllNode= function () {
            var arr=[];
            var node=headNode;
            while(node){
                arr.push(node.getPosition());//将位置放入数组
                node=node.getNext();
            }
            return arr;
        };



        //移动
        this.move= function () {
            headNode.computedNextPos();
        }
    };
//游戏类
    var game= function () {
        var snake;
        var moveTimer=null,foodTimer=null,poisonTime=null;//
        var foods=[];//将产生的食物存起来[{x:x,y:y}]
        var poison=[];
        var curDirection;//键盘事件获取按下的方向
        var context;//用户绘制图形
        var self=this;
        //获取可用空间(随机产生食物的时候，不能再已被占用的地方生成食物)
        //total参数是身体和食物连接起来的数组
        var getRandom= function (total) {
            var avaiable=[];
            for(var i=0;i<width;i++){
                for(var j=0;j<height;j++){
                    var flag=false;
                    for(var n=0;n<total.length;n++){
                        var element=total[n];
                        if(element.x==i&&element.y==j){
                            flag=true;
                            break;
                        }
                    }
                    if(!flag){
                        avaiable.push({"x":i,"y":j});
                    }
                }
            }
            var rand=Math.floor(Math.random()* avaiable.length);
            return avaiable[rand];
        };
        //产生随机食物
        this.createFood= function () {
            var totoal=snake.getAllNode().concat(foods).concat(poison);
            foods.push(getRandom(totoal));
        };
        this.createPoison= function () {
            poison.push(foods[0]);
            foods.splice(0,1);
        };


        //贪吃蛇的移动

        /*游戏级别设置*/
        //获得分数
        this.getScore= function () {
            return snake.getAllNode().length-1;
        };
        //获取级别
        this.getLevel= function () {
            var score=self.getScore();
            var level = 0;
            if(score <= 5) level = 1;
            else if(score <= 12) level = 2;
            else if(score <= 22) level = 3;
            else if(score <= 35) level = 4;
            else if(score <= 50) level = 5;
            else if(score <= 75) level = 6;
            else if(score <= 90) level = 7;
            else if(score <= 100) level = 8;
            else level = 9;
            return level;
        };
        //计算级别（对应settimeout延迟时间）
        var computedMoveLevel= function () {
            var speed = {
                '1':200,
                '2':180,
                '3':160,
                '4':140,
                '5':120,
                '6':100,
                '7':80,
                '8':50,
                '9':20
            };
            var level = self.getLevel();
            return speed[level];
        };

        /*控制方向*/
        //判断当前设置的方向和之前的方向是否冲突
        this.decDirection= function (direction) {
            var headDirection=snake.getHeadDirection();
            if((headDirection=='TOP'||headDirection=='BOTTOM')&&(direction=='RIGHT'||direction=='LEFT'))
                curDirection=direction;
            if((headDirection=='RIGHT'||headDirection=='LEFT')&&(direction=='BOTTOM'||direction=='TOP'))
                curDirection=direction;
        };
        //设置当前移动方向，绑定键盘事件(绑定在开始按钮上面)
        this.setCurrentDirection= function () {
            var that=this;
            document.body.onkeydown= function (e) {
                e=e||window.event;
                switch(e.keyCode){
                    case 37:
                        that.decDirection('LEFT');
                        break;
                    case 38:
                        that.decDirection('TOP');
                        break;
                    case 39:
                        that.decDirection('RIGHT');
                        break;
                    case 40:
                        that.decDirection('BOTTOM');
                        break;
                }
            }
        };
        //取消绑定键盘事件
        this.cancleDirection= function () {
            document.body.onkeydown=null;
        };


        //添加一个监听事件，当贪吃蛇吃到食物，告诉外部dom更新，级别和分数
        this.eatEvent= function () {};

        /*游戏的状态设置*/
        //游戏开始(开始移动,生成食物,绑定键盘事件)
        this.start= function () {
            foodTimer=setInterval(self.createFood,1000);//生成食物
            poisonTime=setInterval(self.createPoison,8000);
            move();//开始移动
            this.setCurrentDirection();//绑定键盘事件
        };
        //游戏结束(贪吃蛇不在移动，食物不在产生，取消键盘绑定事件)
        this.over= function () {
            clearTimeout(moveTimer);//取消移动事件
            clearInterval(foodTimer);//取消产生食物事件
            this.cancleDirection();//取消键盘绑定事件
            alert("游戏结束");
        };
        this.stop= function () {
            clearTimeout(moveTimer);//取消移动事件
            clearInterval(foodTimer);//取消产生食物事件
            clearInterval(poisonTime);//取消产生毒药事件
            this.cancleDirection();//取消键盘绑定事件
        };


        //判断游戏是否结束
        this.GameOver= function () {
            //1.蛇头是否碰到自己的身体(用蛇头的位置循环与蛇身的位置坐比较)
            var headPos=snake.getHeadPos();
            for(var i=1;i<snake.getAllNode().length;i++){
                if(headPos.x==snake.getAllNode()[i].x&&headPos.y==snake.getAllNode()[i].y){
                    return true;
                }
            };
            //2.判断是否越界
            if(headPos.x<0||headPos.y<0||headPos.x>width||headPos.y>height){
                return true;
            }
            //3.蛇头吃到毒药
            for(var i=0;i<poison.length;i++){
                if(headPos.x==poison[i].x&&headPos.y==poison[i].y){
                    return true;
                }
            };
            return false;

        };
        //开始移动
        var move= function () {


            //递归调用自己，模拟setintetval
            moveTimer=setTimeout(move,computedMoveLevel());
            //获取键盘输入的方向，并设置给snake
            if(curDirection) snake.setDirection(curDirection);
            snake.move();//开始移动（即蛇的所有节点不停的计算下一个位置）
            //判断是否吃到了食物
            var snakeHeadPos=snake.getHeadPos();
            for(var i=0;i<foods.length;i++){
                //吃到了食物
                if(snakeHeadPos.x==foods[i].x&&snakeHeadPos.y==foods[i].y){
                    snake.addNode();//增加一个节点
                    foods.splice(i,1);//食物数组的数量减一
                    self.eatEvent();
                    break;
                }
            }
            //判断游戏是否结束
            if(self.GameOver()){
                self.over();
                return ;
            }
            //每移动一次，渲染一下界面
            draw();
        };


        //画地图
        //先把所有的蛇身节点和食物节点转化为对象的形式
        this.arrToMap= function (arr) {
            var map={};
            for(var i=0;i<arr.length;i++){
                var props=arr[i].x+','+arr[i].y;
                map[props]=null;
            }
            return map;
        };
        //将整个地图用对象的形式表示出来
        this.getMap= function () {
            var arr=[];
            for(var i=0;i<width;i++){
                for(var j=0;j<height;j++){
                    arr.push({x:i,y:j});
                }
            }
            //将整个地图制空
            var arrMap=this.arrToMap(arr);
            var sn=this.arrToMap(snake.getAllNode());
            var food=this.arrToMap(foods);
            var poisons=this.arrToMap(poison);
            console.log(poisons);
            console.log(food);
            //console.log(foods);
            for(var key in sn) arrMap[key] = 'snake';
            for(var key in food) arrMap[key] = 'food';
            for(var key in poisons) arrMap[key]='poison';
            return arrMap;
        };
        /**得到如下形式
         *        null null null null null
         *        null null food null null
         *        null null null null null
         *        null snak snak null null
         *        null null null null null
         *
         * */
        var draw= function () {
            context.fillStyle='#fff';//将整个地图绘制成白色
            context.fillRect(0,0,width*10,height*10);
            var map=self.getMap();
            for (var key in map) {
                var pointType = map[key];
                var x = key.split(',')[0];
                var y = key.split(',')[1];

                if (pointType == 'snake') {
                    context.fillStyle = '#000';
                } else if (pointType == 'food') {
                    context.fillStyle = '#f00';
                } else if (pointType == 'poison'){
                    context.fillStyle = 'green';
                }else{
                    continue;
                }
                context.fillRect( x * nodeWidth, y * nodeWidth, nodeWidth, nodeWidth );
            }
        };



        //初始化游戏
        this.initialize= function (canvasId) {
            var headPos={x:Math.ceil(width/2),y:Math.ceil(height/2)};
            var direction='TOP';
            var snakeHead=new snakeNode(headPos,direction);
            snake=new Snake(snakeHead);
            var canvas = document.getElementById(canvasId);
            context = canvas.getContext('2d');
        }
    };

    //初始化
    var newGame = new game();
    newGame.initialize("snake");
    newGame.eatEvent= function () {
        document.getElementById('score').innerHTML='分数：'+this.getScore();
        document.getElementById('level').innerHTML='级别：'+this.getLevel();
    };
    var toggle=document.getElementById('toggle');
    toggle.onclick= function () {
        if(flag){
            newGame.start();
            flag=false;
            this.innerHTML='暂停游戏';
        }else{
            newGame.stop();
            flag=true;
            this.innerHTML='开始游戏';
        }
    };
    document.getElementById('restart').onclick= function () {
        window.location.reload();
    }
</script>
</html>